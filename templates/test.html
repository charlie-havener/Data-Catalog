{% import "_macros.html" as macros %}

<!doctype html>
<html lang="en">

	{{ macros.head() }}
  
	<body class="bg-white">
		{{ macros.navbar() }}

		{{ data }}

		<div id = "container"></div>

		<script>

			const j = {{ data | tojson }};
			const strat = d3.stratify()
				.id(d => d.name)
				.parentId(d => d.parent);
			var root = strat(j);

			const width = 928;
			const dx = 30; // the height difference between rows
			const dy = width / (root.height + 1);
			
			const tree = d3.tree().nodeSize([dx, dy]);

			root.sort((a,b) => d3.ascending(a.data.name, b.data.name));
			tree(root);

			let x0 = Infinity;
			let x1 = -x0;
			root.each(d => {
				if (d.x > x1) x1 = d.x;
				if (d.x < x0) x0 = d.x;
			});


			const height = x1 - x0 + dx * 2;

			const svg = d3.create("svg")
				.attr("width", width)
				.attr("height", height)
				.attr("viewBox", [-dy / 3, x0 - dx, width, height])
				.attr("style", "max-width: 100%; height: auto; font: 10px sans-serif;");

			const link = svg.append("g")
				.attr("fill", "none")
				.attr("stroke", "#555")
				.attr("stroke-opacity", 0.4)
				.attr("stroke-width", 1.5)
				.selectAll()
				.data(root.links())
				.join("path")
				.attr("d", d3.linkHorizontal()
					.x(d => d.y)
					.y(d => d.x));

			const node = svg.append("g")
				.attr("stroke-linejoin", "round")
				.attr("stroke-width", 3)
				.selectAll()
				.data(root.descendants())
				.join("g")
				.attr("id", d => `${d.data.name}`)
				.attr("transform", d => `translate(${d.y}, ${d.x})`)
				.on("mouseover", function(event, d) {
					console.log("hover element with id", d.id);
					for (child of this.children) {
						d3.select(child).attr("fill", "red");
					}
				})
				.on("mouseleave", function(event, d) {
					console.log("hover element with id", d.id);
					for (child of this.children) {
						d3.select(child).attr("fill", "#555");
					}
				});

			node.append("circle")
				.attr("fill", d => d.children ? "#555" : "#555")
				.attr("r", 6);

			node.append("text")
				.attr("dy", "0.31em") // x offset of text
				.attr("x", d => d.children ? -10 : 10) // y offset of text
				.attr("text-anchor", d => d.children ? "end" : "start")
				.text(d => d.data.name)
				.attr("stroke", "white")
				.attr("paint-order", "stroke");

			container.append(svg.node());

		</script>
		
	</body>

</html>
